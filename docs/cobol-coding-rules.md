# WebRings COBOL Coding Rules – Checklist
Nguồn: 【WebRings開発作業標準】コーディング規約（COBOLプログラム作成編）
適用範囲: バッチ処理COBOL（COPY句、フォーム・オーバレイ含む）。既存パッケージ資産は適用外、**新規追加分のみ適用**。

---

## 0. Review Scope (for PR / Copilot)
- レビュー対象: **差分（追加/変更行）**のみ
- レビュー範囲: **規約/スタイルのみ**（ロジック・性能・仕様は対象外）
- 指摘の粒度: 重複を避け、Must/Shouldで分類

---

## 1. Must (マージ前に必ず修正)

### 1.1 桁位置 / インデント
- `<DIVISION.>`, `<SECTION.>` は **41カラム開始**。
- データ定義:
  - `01` レベルはA欄先頭から記述
  - `03` 以降は上位レベルより **2カラム下げ**
  - レベル番号の後ろは **2スペース**
- `PICTURE` 句は **41カラム開始**
- `PIC` の後ろは **2スペース**空けてPIC文字列開始
- `PIC` 文字列の桁数は揃える（`VALUE`, `OCCURS` も同様に揃える）
- `PICTURE`, `MOVE` 等の命令文は **前後行でカラム位置を揃える**
- 日本語（全角）をセクション名/項目名に使う場合も **72カラム超過禁止**（全角+2バイト換算も考慮）

### 1.2 デバッグ行
- 標識領域に `D` を書いた行＝デバッグ行
- 進捗確認の `DISPLAY` は **デバッグ行に記述**
- `WITH DEBUGGING MODE.` で有効化、無効化は **コメントアウト**で制御（デバッグ文を1行ずつ削除しない）

### 1.3 文節の終り（END-xxxx）
- `END-IF`, `END-EVALUATE`, `END-READ` 等の `END-xxxx` は **省略禁止**。必ず全て記述。

### 1.4 修正履歴（ヘッダ部以外）
- 修正量が少ない場合:
  - 修正ステップ直前に「案件番号 + 半角空白 + 日付(yyyy/mm/dd) + 半角空白 + 修正概要」を記述
  - 識別番号領域(72～80)に「日付(yy/mm/dd)+修正者イニシャル」を記述（ヘッダ履歴IDと連動）
  - 修正前ロジックは **コメント化**
- 修正量が多い場合:
  - 修正開始: `*▼ 案件ID ...` を付ける
  - 修正終了: `*▲ 案件ID ...` を付ける
  - 72～80の識別も同様に記述
- 判定ロジックが変わる修正は **ロジック全体をコメント化し、新規に書き直す**（NG: 途中だけコメントでツギハギ）

### 1.5 ENVIRONMENT DIVISION（FILE-CONTROL命名）
- `SELECT <ファイル名> ASSIGN <ファイル識別名>` の対応を統一
- 例: 識別名 `U01` → ファイル名 `U01-FILE`（`A-FILE` のようにズラさない）

### 1.6 DATA DIVISION（FILE SECTION / COPY運用）
- FILE SECTION:
  - `FD U01-FILE.`
  - `01 U01-REC.`
  - レコード構成は **COPY句を使用**
- `JOINING` / `REPLACING` を活用し、手続き部では **OF修飾を極力避ける**
- 置換後文字列は `U01`/`U30` 等、**ファイル識別名と同期**させて「どのファイルの項目か」を明確に

### 1.7 WORKING-STORAGE（レベル/命名）
- レベル番号:
  - 基本は `01`
  - 下位構成は `03` から **2ずつ増加**
  - `03` 以降は上位より **2カラム下げ**
- `PIC` のカラム位置は **項目全体で揃える**
- 命名規約:
  - Work項目: 先頭に `WK` / `WK-` / `W-`
  - 埋込みSQLホスト変数: 先頭に `H` / `H-`、後続は **DB列名と同期**
  - `SQLSTATE` は `PIC X(005)`、`SQLMSG` は `PIC X(256)`
  - マッチングキー: どのファイルのキーか分かる命名。キー値は **LOW-VALUE開始～HIGH-VALUE終了**でコーディング
- コメント:
  - コメントが必要な項目定義は **直前にコメント**
  - コメント開始位置は **項目名の位置に揃える**

### 1.8 LINKAGE SECTION（引数）
- パラメータ項目名: 先頭に `P` / `PARM-` / `P-`
- メインプログラム:
  - 先頭に必ず `PARM-LEN PIC S9(04) COMP.`
  - ジョブ指定形式に合わせて項目定義
- サブプログラム:
  - `PARM-LEN PIC S9(04) COMP.` は **不要**

### 1.9 手続き部（ファイルアクセス例外処理）
- ファイルアクセスを伴うプログラムは、`DECLARATIVES` による宣言部分で **例外処理が実行される構造**にする
- 規約例: `PCBFILERR` COPY を `REPLACING` で展開し、`USE AFTER ERROR PROCEDURE` でハンドリング

### 1.10 セクション構造 / 定型
- ネストが **3層超** になる場合や、処理単位としてまとまる場合は **セクション分割**
- セクション定型:
  - セクション名の前にコメント（処理内容が節名で分かってもコメント自体は書く）
  - `HAJIME`, `OWARI` の段落名、`EXIT.` を記述

### 1.11 MOVE / COMPUTE / 条件式 / INSPECT / ネスト
- MOVE:
  - 対象が複数ある場合、**対象ごとに1行**
  - 項目の書き始めは **前の行と揃える**
- COMPUTE:
  - 計算の基本は **COMPUTE** に統一
  - 剰余が必要な場合のみ **DIVIDE**
  - 式が複雑なら項ごとに改行し、演算子(+,-)は `=` に揃える
- 条件式:
  - **条件は1行に1つ**（`AND` で改行）
- INSPECT:
  - 日本語項目に対して **HEXリテラル禁止**
- ネスト:
  - 最大 **3階層まで**
  - 複雑な階層や強引な `GO TO` は避ける

### 1.12 文字種（元号/住所など）
- 元号（平成/昭和/H/S）編集はオウンコーディング禁止、共通サブ（KAM）使用
- 和暦で年数計算しない（西暦に変換して計算）
- 文字列編集で末尾空白除去などを行う際:
  - `DELIMITED BY SPACE` で分割しない
  - `FUNCTION STORED-CHAR-LENGTH` で有効文字数を取得し、(1:LEN) で編集する

### 1.13 転用新規作成時（清掃ルール）
- 未使用セクションは削除
- DATA DIVISION の未使用変数/ファイル定義は削除
- 改修から2年以上前のコメント修正履歴は削除（ヘッダ部履歴は除く）

### 1.14 ログ出力（UPON / SYSOUT）
- メッセージ出力先機能名は必ず **SYSOUT**
- `CONSOLE` 指定は禁止
- `UPON` 省略時はSYSOUT扱い（またはSPECIAL-NAMESでSYSOUTに紐づいた名称）

---

## 2. Should (推奨：品質・保守性のため)

### 2.1 コメント
- 複雑な処理は必ずコメント。処理概要コメントは簡潔に適時入れる。

### 2.2 ログメッセージの定型（運用観点）
- ジョブ開始/終了、入出力件数、処理に影響するパラメータ値、異常終了理由と特定情報（件数/キー等）をログに出す。
- 開始メッセージ定型:
  - `*** XXXXXXXX START VER.YYYYMMDD ***`
  - `(XXXXXXXX) YYYY/MM/DD hh:mm:ss`
  - `FUNCTION WHEN-COMPILED` でコンパイル日付取得
- 入出力件数表示は桁位置揃え、件数は原則9桁・ゼロサプレス無し、`件/頁` リテラル位置揃え。

---

## 3. COPY句
- ヘッダはCOBOLプログラムヘッダと同様の形式（業務名/顧客名/COPY名/COPY-ID/レコード長 等）
- COPY句のレベル番号は原則 **03から**。`01` は展開側プログラムで記述。
- ファイルレイアウト定義書に基づき項目定義。

---

## 4. フォーム・オーバレイ（該当する場合）
- 1行毎パーティションは保守性が悪いので避け、可能な限り **ページ単位**
  - WRITE文は原則 `WRITE ... AFTER PAGE` のみになるように
- フォーム項目名: 先頭に `F` / `F-`、後続は帳票出力項目と同期
- 外字対応: フォントは `FUJ明朝体`
- OCR項目: `OCRB` または `OCR-B FJ 10cpi`（顧客指定があるので要確認）
- 組み込みメディア項目: 項目長は **100バイト**
- 縦書きフォント（@付）は指定禁止

---

## 5. PR Review 用 Must/Should 判定（おすすめ）
- Must:
  - 桁位置/インデント、END-xxxx、省略禁止、命名prefix、SYSOUT/CONSOLE禁止、条件式1行1条件、ネスト3層
- Should:
  - コメント充実、ログ表示の桁揃え・定型、セクション分割の粒度最適化
